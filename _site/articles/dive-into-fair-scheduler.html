<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Dive into Fair Scheduler &#8211; Hao's Thought Works</title>
<meta name="description" content="">
<meta name="keywords" content="hadoop, mapreduce, code">
<!-- Twitter Cards -->

	<meta name="twitter:card" content="summary">
		<meta name="twitter:image" content="/images/weixin_qrcode_12cm.jpg">
	

<meta name="twitter:title" content="Dive into Fair Scheduler">
<meta name="twitter:description" content="">
<meta name="twitter:creator" content="@hchen7">
<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="blog">
<meta property="og:image" content="http://haoch.me/images/weixin_qrcode_12cm.jpg">
<meta property="og:title" content="Dive into Fair Scheduler">
<meta property="og:description" content="">
<meta property="og:url" content="http://haoch.me/articles/dive-into-fair-scheduler.html">
<meta property="og:site_name" content="Hao's Thought Works">
<!-- Webmaster Tools verfication -->




<link rel="canonical" href="http://haoch.me/articles/dive-into-fair-scheduler.html">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Hao's Thought Works Feed">
<link rel="author" href="https://plus.google.com/103688232748743092549?rel=author">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<meta http-equiv="cleartype" content="on">

<!-- For all browsers -->
<link rel="stylesheet" type="text/css" href="/assets/css/main.min.css">

<!-- Webfonts -->
<script src="//use.edgefonts.net/lato:n3,i3,n4,i4,n7.js" type="text/javascript"></script>

<!-- Load Modernizr -->
<script src="/assets/js/vendor/modernizr-2.6.2.custom.min.js" type="text/javascript"></script>
<!-- Load jQuery -->
<script src="//code.jquery.com/jquery-1.9.1.min.js" data-cfasync="false"></script>
<script data-cfasync="false">window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/images/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/images/favicon.png">
<!-- non-retina iPhone pre iOS 7 -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-57x57-precomposed.png" sizes="57x57">
<!-- non-retina iPad pre iOS 7 -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-72x72-precomposed.png" sizes="72x72">
<!-- non-retina iPad iOS 7 -->
<link rel="apple-touch-icon" href="/images/apple-touch-icon-76x76-precomposed.png" sizes="76x76">
<!-- retina iPhone pre iOS 7 -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-114x114-precomposed.png" sizes="114x114">
<!-- retina iPhone iOS 7 -->
<link rel="apple-touch-icon" href="/images/apple-touch-icon-120x120-precomposed.png" sizes="120x120">
<!-- retina iPad pre iOS 7 -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-144x144-precomposed.png" sizes="144x144">
<!-- retina iPad iOS 7 -->
<link rel="apple-touch-icon" href="/images/apple-touch-icon-152x152-precomposed.png" sizes="152x152">

</head>

<body id="post" itemscope itemtype="http://schema.org/WebPage">

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<div class="site-header">
	<div class="masthead-wrapper">
		<header id="masthead" itemscope itemtype="http://schema.org/Organization">
			<!--
			<a href="http://haoch.me" class="site-logo" rel="home" title="Hao's Thought Works" itemprop="url">
				<img src="http://haoch.me/images/site-logo.jpg" width="50" height="50" alt="Hao's Thought Works logo" itemprop="logo">
			</a>
			-->

			<span class="site-title">					
				<a href="http://haoch.me">Hao's Thought Works</a>
				<span class="bio">Data driving world</span>
			</span>
		</header><!-- /.masthead -->
		<nav role="navigation" id="site-nav" itemscope itemtype="http://schema.org/SiteNavigationElement">
		    <ul>
		        
				<li><a href="http://haoch.me/about.html">About</a></li>
		        
				<li><a href="http://haoch.me/articles">Articles</a></li>
		        
				<li><a href="http://haoch.me/tags">Tags</a></li>
		        
				<li><a href="http://haoch.me/links">Links</a></li>
		        
                
		    </ul>
		</nav>
	</div><!-- /.entry-wrapper -->
</div><!-- /.entry-header -->


<div id="main" role="main" itemprop="mainContentOfPage" itemscope itemtype="http://schema.org/Blog">
  <article class="hentry" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="entry-header">
      <!--
      <div class="entry-image">
        
        
      </div>
      -->
      <!-- /.entry-image -->
      <h1 class="entry-title" itemprop="name">Dive into Fair Scheduler</h1>
    </header>
    <div class="entry-wrapper">
      <div class="entry-content" itemprop="description">
        <h1 id="about-fair-scheduler">About Fair Scheduler</h1>
<p>Fair scheduling is a method of assigning resources to jobs such that all jobs get, on average, an equal share of resources over time. When there is a single job running, that job uses the entire cluster. When other jobs are submitted, tasks slots that free up are assigned to the new jobs, so that each job gets roughly the same amount of CPU time. Unlike the default Hadoop scheduler, which forms a queue of jobs, this lets short jobs finish in reasonable time while not starving long jobs. It is also an easy way to share a cluster between multiple of users. Fair sharing can also work with job priorities - the priorities are used as weights to determine the fraction of total compute time that each job gets.</p>

<p>The fair scheduler organizes jobs into pools, and divides resources fairly between these pools. By default, there is a separate pool for each user, so that each user gets an equal share of the cluster. It is also possible to set a job’s pool based on the user’s Unix group or any jobconf property. Within each pool, jobs can be scheduled using either fair sharing or first-in-first-out (FIFO) scheduling.</p>

<p>In addition to providing fair sharing, the Fair Scheduler allows assigning guaranteed minimum shares to pools, which is useful for ensuring that certain users, groups or production applications always get sufficient resources. When a pool contains jobs, it gets at least its minimum share, but when the pool does not need its full guaranteed share, the excess is split between other pools.</p>

<p>If a pool’s minimum share is not met for some period of time, the scheduler optionally supports preemption of jobs in other pools. The pool will be allowed to kill tasks from other pools to make room to run. Preemption can be used to guarantee that “production” jobs are not starved while also allowing the Hadoop cluster to also be used for experimental and research jobs. In addition, a pool can also be allowed to preempt tasks if it is below half of its fair share for a configurable timeout (generally set larger than the minimum share preemption timeout). When choosing tasks to kill, the fair scheduler picks the most-recently-launched tasks from over-allocated jobs, to minimize wasted computation. Preemption does not cause the preempted jobs to fail, because Hadoop jobs tolerate losing tasks; it only makes them take longer to finish.</p>

<p>The Fair Scheduler can limit the number of concurrent running jobs per user and per pool. This can be useful when a user must submit hundreds of jobs at once, or for ensuring that intermediate data does not fill up disk space on a cluster when too many concurrent jobs are running. Setting job limits causes jobs submitted beyond the limit to wait until some of the user/pool’s earlier jobs finish. Jobs to run from each user/pool are chosen in order of priority and then submit time.</p>

<p>Finally, the Fair Scheduler can limit the number of concurrent running tasks per pool. This can be useful when jobs have a dependency on an external service like a database or web service that could be overloaded if too many map or reduce tasks are run at once.</p>

<h1 id="fifoscheduler-policy">FIFOScheduler Policy</h1>

<p>Core code:
<a href="https://github.com/apache/hadoop-common/blob/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/main/java/org/apache/hadoop/yarn/server/resourcemanager/scheduler/fair/policies/FifoPolicy.java">org.apache.hadoop.yarn.server.resourcemanager.scheduler.fair.policies.FIFOPolicy.java</a></p>

<div class="highlight"><pre><code class="java">  <span class="cm">/**</span>
<span class="cm">   * Compare Schedulables in order of priority and then submission time, as in</span>
<span class="cm">   * the default FIFO scheduler in Hadoop.</span>
<span class="cm">   */</span>
  <span class="kd">static</span> <span class="kd">class</span> <span class="nc">FifoComparator</span> <span class="kd">implements</span> <span class="n">Comparator</span><span class="o">&lt;</span><span class="n">Schedulable</span><span class="o">&gt;,</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5905036205491177060L</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">compare</span><span class="o">(</span><span class="n">Schedulable</span> <span class="n">s1</span><span class="o">,</span> <span class="n">Schedulable</span> <span class="n">s2</span><span class="o">)</span> <span class="o">{</span>
      <span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">s1</span><span class="o">.</span><span class="na">getPriority</span><span class="o">().</span><span class="na">compareTo</span><span class="o">(</span><span class="n">s2</span><span class="o">.</span><span class="na">getPriority</span><span class="o">());</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">res</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">res</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">Math</span><span class="o">.</span><span class="na">signum</span><span class="o">(</span><span class="n">s1</span><span class="o">.</span><span class="na">getStartTime</span><span class="o">()</span> <span class="o">-</span> <span class="n">s2</span><span class="o">.</span><span class="na">getStartTime</span><span class="o">());</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">res</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// In the rare case where jobs were submitted at the exact same time,</span>
        <span class="c1">// compare them by name (which will be the JobID) to get a deterministic</span>
        <span class="c1">// ordering, so we don&#39;t alternately launch tasks from different jobs.</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">s1</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">compareTo</span><span class="o">(</span><span class="n">s2</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">res</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>


  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">computeShares</span><span class="o">(</span><span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Schedulable</span><span class="o">&gt;</span> <span class="n">schedulables</span><span class="o">,</span>
      <span class="n">Resource</span> <span class="n">totalResources</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">schedulables</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">Schedulable</span> <span class="n">earliest</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">Schedulable</span> <span class="n">schedulable</span> <span class="o">:</span> <span class="n">schedulables</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">earliest</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span>
          <span class="n">schedulable</span><span class="o">.</span><span class="na">getStartTime</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">earliest</span><span class="o">.</span><span class="na">getStartTime</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">earliest</span> <span class="o">=</span> <span class="n">schedulable</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">earliest</span><span class="o">.</span><span class="na">setFairShare</span><span class="o">(</span><span class="n">Resources</span><span class="o">.</span><span class="na">clone</span><span class="o">(</span><span class="n">totalResources</span><span class="o">));</span>
  <span class="o">}</span> 
</code></pre></div>

<h1 id="fairscheduler-policy">FairScheduler Policy</h1>

<p>FairScheduler policy core code：
<a href="https://github.com/apache/hadoop-common/blob/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/main/java/org/apache/hadoop/yarn/server/resourcemanager/scheduler/fair/policies/FairSharePolicy.java#L65">org.apache.hadoop.yarn.server.resourcemanager.scheduler.fair.policies.FairSharePolicy.java</a></p>

<div class="highlight"><pre><code class="java"><span class="cm">/**</span>
<span class="cm">   * Compare Schedulables via weighted fair sharing. In addition, Schedulables</span>
<span class="cm">   * below their min share get priority over those whose min share is met.</span>
<span class="cm">   *</span>
<span class="cm">   * Schedulables below their min share are compared by how far below it they</span>
<span class="cm">   * are as a ratio. For example, if job A has 8 out of a min share of 10 tasks</span>
<span class="cm">   * and job B has 50 out of a min share of 100, then job B is scheduled next,</span>
<span class="cm">   * because B is at 50% of its min share and A is at 80% of its min share.</span>
<span class="cm">   *</span>
<span class="cm">   * Schedulables above their min share are compared by (runningTasks / weight).</span>
<span class="cm">   * If all weights are equal, slots are given to the job with the fewest tasks;</span>
<span class="cm">   * otherwise, jobs with more weight get proportionally more slots.</span>
<span class="cm">   */</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">FairShareComparator</span> <span class="kd">implements</span> <span class="n">Comparator</span><span class="o">&lt;</span><span class="n">Schedulable</span><span class="o">&gt;,</span>
          <span class="n">Serializable</span> <span class="o">{</span>
      <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">5564969375856699313L</span><span class="o">;</span>

      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="kt">int</span> <span class="nf">compare</span><span class="o">(</span><span class="n">Schedulable</span> <span class="n">s1</span><span class="o">,</span> <span class="n">Schedulable</span> <span class="n">s2</span><span class="o">)</span> <span class="o">{</span>
          <span class="kt">double</span> <span class="n">minShareRatio1</span><span class="o">,</span> <span class="n">minShareRatio2</span><span class="o">;</span>
          <span class="kt">double</span> <span class="n">useToWeightRatio1</span><span class="o">,</span> <span class="n">useToWeightRatio2</span><span class="o">;</span>
          <span class="n">Resource</span> <span class="n">minShare1</span> <span class="o">=</span> <span class="n">Resources</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="n">RESOURCE_CALCULATOR</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span>
                  <span class="n">s1</span><span class="o">.</span><span class="na">getMinShare</span><span class="o">(),</span> <span class="n">s1</span><span class="o">.</span><span class="na">getDemand</span><span class="o">());</span>
          <span class="n">Resource</span> <span class="n">minShare2</span> <span class="o">=</span> <span class="n">Resources</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="n">RESOURCE_CALCULATOR</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span>
                  <span class="n">s2</span><span class="o">.</span><span class="na">getMinShare</span><span class="o">(),</span> <span class="n">s2</span><span class="o">.</span><span class="na">getDemand</span><span class="o">());</span>
          <span class="kt">boolean</span> <span class="n">s1Needy</span> <span class="o">=</span> <span class="n">Resources</span><span class="o">.</span><span class="na">lessThan</span><span class="o">(</span><span class="n">RESOURCE_CALCULATOR</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span>
                  <span class="n">s1</span><span class="o">.</span><span class="na">getResourceUsage</span><span class="o">(),</span> <span class="n">minShare1</span><span class="o">);</span>
          <span class="kt">boolean</span> <span class="n">s2Needy</span> <span class="o">=</span> <span class="n">Resources</span><span class="o">.</span><span class="na">lessThan</span><span class="o">(</span><span class="n">RESOURCE_CALCULATOR</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span>
                  <span class="n">s2</span><span class="o">.</span><span class="na">getResourceUsage</span><span class="o">(),</span> <span class="n">minShare2</span><span class="o">);</span>
          <span class="n">Resource</span> <span class="n">one</span> <span class="o">=</span> <span class="n">Resources</span><span class="o">.</span><span class="na">createResource</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
          <span class="n">minShareRatio1</span> <span class="o">=</span> <span class="o">(</span><span class="kt">double</span><span class="o">)</span> <span class="n">s1</span><span class="o">.</span><span class="na">getResourceUsage</span><span class="o">().</span><span class="na">getMemory</span><span class="o">()</span>
                  <span class="o">/</span> <span class="n">Resources</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="n">RESOURCE_CALCULATOR</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">minShare1</span><span class="o">,</span> <span class="n">one</span><span class="o">).</span><span class="na">getMemory</span><span class="o">();</span>
          <span class="n">minShareRatio2</span> <span class="o">=</span> <span class="o">(</span><span class="kt">double</span><span class="o">)</span> <span class="n">s2</span><span class="o">.</span><span class="na">getResourceUsage</span><span class="o">().</span><span class="na">getMemory</span><span class="o">()</span>
                  <span class="o">/</span> <span class="n">Resources</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="n">RESOURCE_CALCULATOR</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">minShare2</span><span class="o">,</span> <span class="n">one</span><span class="o">).</span><span class="na">getMemory</span><span class="o">();</span>
          <span class="n">useToWeightRatio1</span> <span class="o">=</span> <span class="n">s1</span><span class="o">.</span><span class="na">getResourceUsage</span><span class="o">().</span><span class="na">getMemory</span><span class="o">()</span> <span class="o">/</span>
                  <span class="n">s1</span><span class="o">.</span><span class="na">getWeights</span><span class="o">().</span><span class="na">getWeight</span><span class="o">(</span><span class="n">ResourceType</span><span class="o">.</span><span class="na">MEMORY</span><span class="o">);</span>
          <span class="n">useToWeightRatio2</span> <span class="o">=</span> <span class="n">s2</span><span class="o">.</span><span class="na">getResourceUsage</span><span class="o">().</span><span class="na">getMemory</span><span class="o">()</span> <span class="o">/</span>
                  <span class="n">s2</span><span class="o">.</span><span class="na">getWeights</span><span class="o">().</span><span class="na">getWeight</span><span class="o">(</span><span class="n">ResourceType</span><span class="o">.</span><span class="na">MEMORY</span><span class="o">);</span>
          <span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">s1Needy</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">s2Needy</span><span class="o">)</span>
              <span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
          <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">s2Needy</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">s1Needy</span><span class="o">)</span>
              <span class="n">res</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
          <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">s1Needy</span> <span class="o">&amp;&amp;</span> <span class="n">s2Needy</span><span class="o">)</span>
              <span class="n">res</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">Math</span><span class="o">.</span><span class="na">signum</span><span class="o">(</span><span class="n">minShareRatio1</span> <span class="o">-</span> <span class="n">minShareRatio2</span><span class="o">);</span>
          <span class="k">else</span>
              <span class="c1">// Neither schedulable is needy</span>
              <span class="n">res</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">Math</span><span class="o">.</span><span class="na">signum</span><span class="o">(</span><span class="n">useToWeightRatio1</span> <span class="o">-</span> <span class="n">useToWeightRatio2</span><span class="o">);</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">res</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
              <span class="c1">// Apps are tied in fairness ratio. Break the tie by submit time and job</span>
              <span class="c1">// name to get a deterministic ordering, which is useful for unit tests.</span>
              <span class="n">res</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">Math</span><span class="o">.</span><span class="na">signum</span><span class="o">(</span><span class="n">s1</span><span class="o">.</span><span class="na">getStartTime</span><span class="o">()</span> <span class="o">-</span> <span class="n">s2</span><span class="o">.</span><span class="na">getStartTime</span><span class="o">());</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">res</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
                  <span class="n">res</span> <span class="o">=</span> <span class="n">s1</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">compareTo</span><span class="o">(</span><span class="n">s2</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
          <span class="o">}</span>
          <span class="k">return</span> <span class="n">res</span><span class="o">;</span>
      <span class="o">}</span>
  <span class="o">}</span> 

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">computeShares</span><span class="o">(</span><span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Schedulable</span><span class="o">&gt;</span> <span class="n">schedulables</span><span class="o">,</span>
      <span class="n">Resource</span> <span class="n">totalResources</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">ComputeFairShares</span><span class="o">.</span><span class="na">computeShares</span><span class="o">(</span><span class="n">schedulables</span><span class="o">,</span> <span class="n">totalResources</span><span class="o">,</span> <span class="n">ResourceType</span><span class="o">.</span><span class="na">MEMORY</span><span class="o">);</span>
  <span class="o">}</span> 
</code></pre></div>

<h1 id="dominantresourcefairness-policy">DominantResourceFairness Policy</h1>

<p>DominantResourceFairness policy core code: 
<a href="https://github.com/apache/hadoop-common/blob/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/main/java/org/apache/hadoop/yarn/server/resourcemanager/scheduler/fair/policies/DominantResourceFairnessPolicy.java#L87">org.apache.hadoop.yarn.server.resourcemanager.scheduler.fair.policies.DominantResourceFairnessPolicy.java</a></p>

<div class="highlight"><pre><code class="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">DominantResourceFairnessComparator</span> <span class="kd">implements</span> <span class="n">Comparator</span><span class="o">&lt;</span><span class="n">Schedulable</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">NUM_RESOURCES</span> <span class="o">=</span> <span class="n">ResourceType</span><span class="o">.</span><span class="na">values</span><span class="o">().</span><span class="na">length</span><span class="o">;</span>
   
    <span class="kd">private</span> <span class="n">Resource</span> <span class="n">clusterCapacity</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setClusterCapacity</span><span class="o">(</span><span class="n">Resource</span> <span class="n">clusterCapacity</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">clusterCapacity</span> <span class="o">=</span> <span class="n">clusterCapacity</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">compare</span><span class="o">(</span><span class="n">Schedulable</span> <span class="n">s1</span><span class="o">,</span> <span class="n">Schedulable</span> <span class="n">s2</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">ResourceWeights</span> <span class="n">sharesOfCluster1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ResourceWeights</span><span class="o">();</span>
      <span class="n">ResourceWeights</span> <span class="n">sharesOfCluster2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ResourceWeights</span><span class="o">();</span>
      <span class="n">ResourceWeights</span> <span class="n">sharesOfMinShare1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ResourceWeights</span><span class="o">();</span>
      <span class="n">ResourceWeights</span> <span class="n">sharesOfMinShare2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ResourceWeights</span><span class="o">();</span>
      <span class="n">ResourceType</span><span class="o">[]</span> <span class="n">resourceOrder1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ResourceType</span><span class="o">[</span><span class="n">NUM_RESOURCES</span><span class="o">];</span>
      <span class="n">ResourceType</span><span class="o">[]</span> <span class="n">resourceOrder2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ResourceType</span><span class="o">[</span><span class="n">NUM_RESOURCES</span><span class="o">];</span>
     
      <span class="c1">// Calculate shares of the cluster for each resource both schedulables.</span>
      <span class="n">calculateShares</span><span class="o">(</span><span class="n">s1</span><span class="o">.</span><span class="na">getResourceUsage</span><span class="o">(),</span>
          <span class="n">clusterCapacity</span><span class="o">,</span> <span class="n">sharesOfCluster1</span><span class="o">,</span> <span class="n">resourceOrder1</span><span class="o">,</span> <span class="n">s1</span><span class="o">.</span><span class="na">getWeights</span><span class="o">());</span>
      <span class="n">calculateShares</span><span class="o">(</span><span class="n">s1</span><span class="o">.</span><span class="na">getResourceUsage</span><span class="o">(),</span>
          <span class="n">s1</span><span class="o">.</span><span class="na">getMinShare</span><span class="o">(),</span> <span class="n">sharesOfMinShare1</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">ResourceWeights</span><span class="o">.</span><span class="na">NEUTRAL</span><span class="o">);</span>
      <span class="n">calculateShares</span><span class="o">(</span><span class="n">s2</span><span class="o">.</span><span class="na">getResourceUsage</span><span class="o">(),</span>
          <span class="n">clusterCapacity</span><span class="o">,</span> <span class="n">sharesOfCluster2</span><span class="o">,</span> <span class="n">resourceOrder2</span><span class="o">,</span> <span class="n">s2</span><span class="o">.</span><span class="na">getWeights</span><span class="o">());</span>
      <span class="n">calculateShares</span><span class="o">(</span><span class="n">s2</span><span class="o">.</span><span class="na">getResourceUsage</span><span class="o">(),</span>
          <span class="n">s2</span><span class="o">.</span><span class="na">getMinShare</span><span class="o">(),</span> <span class="n">sharesOfMinShare2</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">ResourceWeights</span><span class="o">.</span><span class="na">NEUTRAL</span><span class="o">);</span>
     
      <span class="c1">// A queue is needy for its min share if its dominant resource</span>
      <span class="c1">// (with respect to the cluster capacity) is below its configured min share</span>
      <span class="c1">// for that resource</span>
      <span class="kt">boolean</span> <span class="n">s1Needy</span> <span class="o">=</span> <span class="n">sharesOfMinShare1</span><span class="o">.</span><span class="na">getWeight</span><span class="o">(</span><span class="n">resourceOrder1</span><span class="o">[</span><span class="mi">0</span><span class="o">])</span> <span class="o">&lt;</span> <span class="mf">1.0f</span><span class="o">;</span>
      <span class="kt">boolean</span> <span class="n">s2Needy</span> <span class="o">=</span> <span class="n">sharesOfMinShare2</span><span class="o">.</span><span class="na">getWeight</span><span class="o">(</span><span class="n">resourceOrder2</span><span class="o">[</span><span class="mi">0</span><span class="o">])</span> <span class="o">&lt;</span> <span class="mf">1.0f</span><span class="o">;</span>
     
      <span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">s2Needy</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">s1Needy</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">compareShares</span><span class="o">(</span><span class="n">sharesOfCluster1</span><span class="o">,</span> <span class="n">sharesOfCluster2</span><span class="o">,</span>
            <span class="n">resourceOrder1</span><span class="o">,</span> <span class="n">resourceOrder2</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">s1Needy</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">s2Needy</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">s2Needy</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">s1Needy</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">res</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span> <span class="c1">// both are needy below min share</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">compareShares</span><span class="o">(</span><span class="n">sharesOfMinShare1</span><span class="o">,</span> <span class="n">sharesOfMinShare2</span><span class="o">,</span>
            <span class="n">resourceOrder1</span><span class="o">,</span> <span class="n">resourceOrder2</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">res</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Apps are tied in fairness ratio. Break the tie by submit time.</span>
        <span class="n">res</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)(</span><span class="n">s1</span><span class="o">.</span><span class="na">getStartTime</span><span class="o">()</span> <span class="o">-</span> <span class="n">s2</span><span class="o">.</span><span class="na">getStartTime</span><span class="o">());</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">res</span><span class="o">;</span>
    <span class="o">}</span>
   
    <span class="cm">/**</span>
<span class="cm">     * Calculates and orders a resource&#39;s share of a pool in terms of two vectors.</span>
<span class="cm">     * The shares vector contains, for each resource, the fraction of the pool that</span>
<span class="cm">     * it takes up.  The resourceOrder vector contains an ordering of resources</span>
<span class="cm">     * by largest share.  So if resource=&lt;10 MB, 5 CPU&gt;, and pool=&lt;100 MB, 10 CPU&gt;,</span>
<span class="cm">     * shares will be [.1, .5] and resourceOrder will be [CPU, MEMORY].</span>
<span class="cm">     */</span>
    <span class="kt">void</span> <span class="nf">calculateShares</span><span class="o">(</span><span class="n">Resource</span> <span class="n">resource</span><span class="o">,</span> <span class="n">Resource</span> <span class="n">pool</span><span class="o">,</span>
        <span class="n">ResourceWeights</span> <span class="n">shares</span><span class="o">,</span> <span class="n">ResourceType</span><span class="o">[]</span> <span class="n">resourceOrder</span><span class="o">,</span> <span class="n">ResourceWeights</span> <span class="n">weights</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">shares</span><span class="o">.</span><span class="na">setWeight</span><span class="o">(</span><span class="n">MEMORY</span><span class="o">,</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span><span class="n">resource</span><span class="o">.</span><span class="na">getMemory</span><span class="o">()</span> <span class="o">/</span>
          <span class="o">(</span><span class="n">pool</span><span class="o">.</span><span class="na">getMemory</span><span class="o">()</span> <span class="o">*</span> <span class="n">weights</span><span class="o">.</span><span class="na">getWeight</span><span class="o">(</span><span class="n">MEMORY</span><span class="o">)));</span>
      <span class="n">shares</span><span class="o">.</span><span class="na">setWeight</span><span class="o">(</span><span class="n">CPU</span><span class="o">,</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span><span class="n">resource</span><span class="o">.</span><span class="na">getVirtualCores</span><span class="o">()</span> <span class="o">/</span>
          <span class="o">(</span><span class="n">pool</span><span class="o">.</span><span class="na">getVirtualCores</span><span class="o">()</span> <span class="o">*</span> <span class="n">weights</span><span class="o">.</span><span class="na">getWeight</span><span class="o">(</span><span class="n">CPU</span><span class="o">)));</span>
      <span class="c1">// sort order vector by resource share</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">resourceOrder</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">shares</span><span class="o">.</span><span class="na">getWeight</span><span class="o">(</span><span class="n">MEMORY</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">shares</span><span class="o">.</span><span class="na">getWeight</span><span class="o">(</span><span class="n">CPU</span><span class="o">))</span> <span class="o">{</span>
          <span class="n">resourceOrder</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="n">MEMORY</span><span class="o">;</span>
          <span class="n">resourceOrder</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="n">CPU</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span>  <span class="o">{</span>
          <span class="n">resourceOrder</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="n">CPU</span><span class="o">;</span>
          <span class="n">resourceOrder</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="n">MEMORY</span><span class="o">;</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
   
    <span class="kd">private</span> <span class="kt">int</span> <span class="nf">compareShares</span><span class="o">(</span><span class="n">ResourceWeights</span> <span class="n">shares1</span><span class="o">,</span> <span class="n">ResourceWeights</span> <span class="n">shares2</span><span class="o">,</span>
        <span class="n">ResourceType</span><span class="o">[]</span> <span class="n">resourceOrder1</span><span class="o">,</span> <span class="n">ResourceType</span><span class="o">[]</span> <span class="n">resourceOrder2</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">resourceOrder1</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span><span class="n">Math</span><span class="o">.</span><span class="na">signum</span><span class="o">(</span><span class="n">shares1</span><span class="o">.</span><span class="na">getWeight</span><span class="o">(</span><span class="n">resourceOrder1</span><span class="o">[</span><span class="n">i</span><span class="o">])</span>
            <span class="o">-</span> <span class="n">shares2</span><span class="o">.</span><span class="na">getWeight</span><span class="o">(</span><span class="n">resourceOrder2</span><span class="o">[</span><span class="n">i</span><span class="o">]));</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">return</span> <span class="n">ret</span><span class="o">;</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span> 
</code></pre></div>

<blockquote>
  <blockquote>
    <h2 id="uncompleted">UNCOMPLETED</h2>
  </blockquote>
</blockquote>


       <br /> <small>（转载本站文章请注明作者和出处 <a href="/articles/dive-into-fair-scheduler.html">haoch.me</a>，请勿用于任何商业用途）</small>

        
        <hr />
        <div class="entry-meta">
          <a href="http://haoch.me/about.html"><img src="http://haoch.me/images/bio-photo-200x200.png" alt="Hao photo" class="author-photo" width="30" height="30"></a>
          <span class="author vcard" itemprop="author" itemscope itemtype="http://schema.org/Person">Published by <span itemprop="name" class="fn"><a href="http://haoch.me/about.html" title="About Hao" itemprop="url">Hao</a></span> on </span>
          <span class="entry-date date published"><time datetime="2013-12-20T00:00:00+01:00" itemprop="datePublished">December 20, 2013</time></span>
          
          <span class="entry-tags">
              <a href="http://haoch.me/tag/hadoop" title="hadoop" class="tag" rel="tag">hadoop</a><a href="http://haoch.me/tag/mapreduce" title="mapreduce" class="tag" rel="tag">mapreduce</a><a href="http://haoch.me/tag/code" title="code" class="tag" rel="tag">code</a>
          </span>
            <!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style addthis_32x32_style addthis_sharing">
<a class="addthis_button_sinaweibo"></a>
<a class="addthis_button_twitter"></a>
<a class="addthis_button_google_plusone_share"></a>
<a class="addthis_button_facebook"></a>
<a class="addthis_button_linkedin"></a>
<a class="addthis_button_compact"></a><a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript">var addthis_config = {"data_track_addressbar":false};</script>
<!-- AddThis Button END -->


        </div><!-- /.entry-meta -->
      </div><!-- /.entry-content -->
      
      <nav class="pagination" role="navigation">
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
            
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
            
          
          
        
          
          
        
          
          
            
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
        
          <a href="/articles/netflix-genie.html" class="previous-link" title="Previous article"><i class="icon-chevron-left icon-large"></i> <span>Previous</span></a>
        
          <a href="http://haoch.me/articles/" class="archive-link"><i class="icon-list-ul icon-large"></i> <span>Archive</span></a>
        
          <a href="/articles/internet-finance.html" class="next-link" title="Next article"><i class="icon-chevron-right icon-large"></i> <span>Next</span></a>
        
    </nav><!-- /.pagination -->
    <div id="disqus_thread"></div><!-- /#disqus_thread -->
    <div id="addthis_trendingcontent"></div>
    </div><!-- /.entry-wrapper -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span class="disclaimer">
    Proudly built with <a href="http://jekyllrb.com/">Jekyll</a> and  hosted by <a href="http://github.com">Github</a>. <a href="/terms.html">Privacy and Disclosure Policies</a>
</span>

<div class="social-icons">
	<a href="http://github.com/haoch" title="Hao on Github" target="_blank"><i class="icon-github icon-2x"></i></a>
	<a href="http://linkedin.com/in/ihaochen" title="Hao on LinkedIn" target="_blank"><i class="icon-linkedin icon-2x"></i></a>
	<a href="http://weibo.com/haochencn" title="Hao on Weibo" target="_blank"><i class="icon-weibo icon-2x"></i></a>
	<a href="http://twitter.com/hchen7" title="Hao on Twitter" target="_blank"><i class="icon-twitter icon-2x"></i></a>
	<a href="http://facebook.com/haochencn" title="Hao on Facebook" target="_blank"><i class="icon-facebook icon-2x"></i></a>
	<a href="https://plus.google.com/103688232748743092549" title="Hao on Google+" target="_blank"><i class="icon-google-plus icon-2x"></i></a>
	<a href="http://instagram.com/haochen90" title="Hao on Instagram" target="_blank"><i class="icon-instagram icon-2x"></i></a>
	
	<a href="http://feeds.feedburner.com/MadeMistakes" title="Atom/RSS feed"><i class="icon-rss icon-2x"></i></a>
</div>

<!-- /.social-icons -->

  </footer>
</div><!-- /.footer-wrapper -->
<script data-cfasync="false" type="text/javascript" src="/assets/js/main.min.js"></script>
<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl = 
 '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-40551822-2']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'haoch'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript><div class="upgrade">Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></div></noscript>
<!-- AddThis Smart Layers BEGIN -->
<!-- Go to http://www.addthis.com/get/smart-layers to customize -->

<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-52aadb5c3b6ff852"></script>
<script type="text/javascript">
addthis.layers({
  'theme' : 'transparent',
  'domain' : 'haoch.me',
  /* 'share' : {
    'position' : 'left',
    'numPreferredServices' : 6,
    'offset':{
      'top':'25%'
    },
    'services':'twitter,sinaweibo,facebook,google_plusone_share,email,more'
  },*/ 
  'follow' : {
    'services' : [
      {'service': 'sinaweibo', 'id': 'Hochn'},
      {'service': 'twitter', 'id': 'HChen7'},
      {'service': 'facebook', 'id': 'haochencn'},
      {'service': 'linkedin', 'id': 'ihaochen'},
      {'service': 'google_follow', 'id': '103688232748743092549'},
      {'service': 'rss', 'id': 'http://haoch.me/feed.xml'}
    ]
  },  
  'whatsnext' : {
      'recommendedTitle' : 'Recommended for you',
      'shareMsg' : 'Share to [x]',
      'followMsg' : 'Follow us on [x]',
      'theme' : 'transparent',
      'desktop' : true
  }
  /*
  ,  
  'recommended' : {
      'title' : 'Recommended for you',
      'mobile' : true,
      'desktop' : true,
      'theme' : 'transparent'
  } */
});
addthis.box("#addthis_trendingcontent", {
    feed_title : "Popular Articles - 热门文章",
    feed_type : "trending",
    feed_period : "month",
    num_links : 5,
    height : "auto",
   width : "auto"});
</script>
<!-- AddThis Smart Layers END -->
<!-- AddThis Welcome BEGIN -->
<script type='text/javascript'>
addthis.bar.initialize({'default':{
	"backgroundColor": "#000000",
	"buttonColor": "#098DF4",
	"textColor": "#FFFFFF",
	"buttonTextColor": "#FFFFFF",
	"hideAfter": 20
},rules:[
	{
		"name": "Twitter",
		"match": {
			"referringService": "twitter"
		},
		"message": "If you find this page helpful:",
		"action": {
			"type": "button",
			"text": "Tweet it!",
			"verb": "share",
			"service": "twitter"
		}
	},
	{
		"name": "Facebook",
		"match": {
			"referringService": "facebook"
		},
		"message": "Tell your friends about us:",
		"action": {
			"type": "button",
			"text": "Share on Facebook",
			"verb": "share",
			"service": "facebook"
		}
	},
	{
		"name": "Google",
		"match": {
			"referrer": "google.com"
		},
		"message": "If you like this page, let Google know:",
		"action": {
			"type": "button",
			"text": "+1",
			"verb": "share",
			"service": "google_plusone_share"
		}
	},
	{
		"name": "sinaweibo",
		"match": {
			"referringService": "sinaweibo"
		},
		"message": "If you enjoy this page, do us a favor:",
		"action": {
			"type": "button",
			"text": "Post on Sina Weibo",
			"verb": "share",
			"service": "sinaweibo"
		}
	},
	{
		"name": "linkedin",
		"match": {
			"referringService": "linkedin"
		},
		"message": "If you enjoy this page, do us a favor:",
		"action": {
			"type": "button",
			"text": "Post on LinkedIn",
			"verb": "share",
			"service": "linkedin"
		}
	},
	{
		"name": "baidu",
		"match": {
			"referringService": "baidu"
		},
		"message": "If you enjoy this page, do us a favor:",
		"action": {
			"type": "button",
			"text": "Post on Baidu",
			"verb": "share",
			"service": "baidu"
		}
	},
	{
		"name": "qzone",
		"match": {
			"referringService": "qzone"
		},
		"message": "If you enjoy this page, do us a favor:",
		"action": {
			"type": "button",
			"text": "Post on Qzone",
			"verb": "share",
			"service": "qzone"
		}
	},
	{
		"name": "blogger",
		"match": {
			"referringService": "blogger"
		},
		"message": "If you enjoy this page, do us a favor:",
		"action": {
			"type": "button",
			"text": "Post on Blogger",
			"verb": "share",
			"service": "blogger"
		}
	},
	{
		"name": "digg",
		"match": {
			"referringService": "digg"
		},
		"message": "If you enjoy this page, do us a favor:",
		"action": {
			"type": "button",
			"text": "Post on Digg",
			"verb": "share",
			"service": "digg"
		}
	},
	{
		"name": "google_plusone_share",
		"match": {
			"referringService": "google_plusone_share"
		},
		"message": "If you enjoy this page, do us a favor:",
		"action": {
			"type": "button",
			"text": "Post on Google+ Share",
			"verb": "share",
			"service": "google_plusone_share"
		}
	},
	{
		"name": "email",
		"match": {
			"referringService": "email"
		},
		"message": "If you enjoy this page, do us a favor:",
		"action": {
			"type": "button",
			"text": "Post on Email",
			"verb": "share",
			"service": "email"
		}
	}
]});
</script>
<!-- AddThis Welcome END -->

</body>
</html>
